// XHR Hook - 监控所有XMLHttpRequest请求
(function() {
    const originalOpen = XMLHttpRequest.prototype.open;
    const originalSend = XMLHttpRequest.prototype.send;
    const originalSetRequestHeader = XMLHttpRequest.prototype.setRequestHeader;

    XMLHttpRequest.prototype.open = function(method, url, async, user, password) {
        this._hookData = { method, url, headers: {} };
        console.log('[XHR Open]', method, url);
        return originalOpen.apply(this, arguments);
    };

    XMLHttpRequest.prototype.setRequestHeader = function(name, value) {
        if (this._hookData) {
            this._hookData.headers[name] = value;
        }
        console.log('[XHR Header]', name, ':', value);
        return originalSetRequestHeader.apply(this, arguments);
    };

    XMLHttpRequest.prototype.send = function(body) {
        console.log('[XHR Send]', this._hookData?.url, body);

        // 监听响应
        this.addEventListener('load', function() {
            console.log('[XHR Response]', this._hookData?.url, this.responseText?.substring(0, 500));
        });

        return originalSend.apply(this, arguments);
    };

    console.log('[Hook] XHR Hook 已注入');
})();
